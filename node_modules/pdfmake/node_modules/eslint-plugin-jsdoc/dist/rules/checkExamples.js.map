{"version":3,"sources":["../../src/rules/checkExamples.js"],"names":["zeroBasedLineIndexAdjust","likelyNestedJSDocIndentSpace","preTagSpaceLength","hasCaptionRegex","escapeStringRegexp","str","replace","countChars","ch","match","RegExp","length","report","utils","exampleCodeRegex","getExampleCodeRegex","rejectExampleCodeRegex","getRejectExampleCodeRegex","noDefaultExampleRules","hasNoDefaultExampleRules","eslintrcForExamples","useEslintrcForExamples","filename","getMatchingFileName","baseConfig","getBaseConfig","configFile","getConfigFile","allowInlineConfig","reportUnusedDisableDirectives","rulePaths","rules","undefined","forEachTag","tag","initialTag","source","initialTagLength","firstLinePrefixLength","slice","isCaptionRequired","test","nonJSPrefacingLines","nonJSPrefacingCols","idx","search","preMatchLines","preMatch","colDelta","lastIndexOf","n0","n1","index","indexOf","nonJSPreface","nonJSPrefaceLineCount","charsInLastLine","cli","CLIEngine","useEslintrc","messages","config","getConfigForFile","linter","Linter","linterRules","getRules","entries","reduce","obj","key","val","defineRules","verify","executeOnText","results","codeStartLine","line","codeStartCol","forEach","message","column","severity","ruleId","startLine","startCol","meta","type","returns"],"mappings":"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","sourcesContent":["import {CLIEngine, Linter} from 'eslint';\nimport iterateJsdoc from '../iterateJsdoc';\n\nconst zeroBasedLineIndexAdjust = -1;\nconst likelyNestedJSDocIndentSpace = 1;\nconst preTagSpaceLength = 1;\nconst hasCaptionRegex = /^\\s*<caption>.*?<\\/caption>/;\n\nconst escapeStringRegexp = (str) => {\n  return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n};\nconst countChars = (str, ch) => {\n  return (str.match(new RegExp(escapeStringRegexp(ch), 'g')) || []).length;\n};\n\nexport default iterateJsdoc(({\n  report,\n  utils\n}) => {\n  let exampleCodeRegex = utils.getExampleCodeRegex();\n  let rejectExampleCodeRegex = utils.getRejectExampleCodeRegex();\n  const noDefaultExampleRules = utils.hasNoDefaultExampleRules();\n  const eslintrcForExamples = utils.useEslintrcForExamples();\n  const filename = utils.getMatchingFileName();\n  const baseConfig = utils.getBaseConfig();\n  const configFile = utils.getConfigFile();\n  const allowInlineConfig = utils.allowInlineConfig();\n  const reportUnusedDisableDirectives = utils.reportUnusedDisableDirectives();\n\n  // Make this configurable?\n  const rulePaths = [];\n\n  const rules = noDefaultExampleRules ? undefined : {\n    // \"always\" newline rule at end unlikely in sample code\n    'eol-last': 0,\n\n    // Wouldn't generally expect example paths to resolve relative to JS file\n    'import/no-unresolved': 0,\n\n    // Snippets likely too short to always include import/export info\n    'import/unambiguous': 0,\n\n    // Unlikely to have inadvertent debugging within examples\n    'no-console': 0,\n\n    // Many variables in examples will be `undefined`\n    'no-undef': 0,\n\n    // Common to define variables for clarity without always using them\n    'no-unused-vars': 0,\n\n    // See import/no-unresolved\n    'node/no-missing-import': 0,\n    'node/no-missing-require': 0,\n\n    // Can generally look nicer to pad a little even if code imposes more stringency\n    'padded-blocks': 0\n  };\n\n  exampleCodeRegex = exampleCodeRegex && new RegExp(exampleCodeRegex, '');\n  rejectExampleCodeRegex = rejectExampleCodeRegex && new RegExp(rejectExampleCodeRegex, '');\n\n  utils.forEachTag('example', (tag) => {\n    // If a space is present, we should ignore it\n    const initialTag = tag.source.match(/^@example ?/);\n    const initialTagLength = initialTag[0].length;\n    const firstLinePrefixLength = preTagSpaceLength + initialTagLength;\n\n    let source = tag.source.slice(initialTagLength);\n    const match = source.match(hasCaptionRegex);\n\n    if (utils.isCaptionRequired() && !match) {\n      report('Caption is expected for examples.', null, tag);\n    }\n\n    // If we allow newlines in hasCaptionRegex, we should add to line count\n    source = source.replace(hasCaptionRegex, '');\n\n    if (exampleCodeRegex && !exampleCodeRegex.test(source) ||\n      rejectExampleCodeRegex && rejectExampleCodeRegex.test(source)\n    ) {\n      return;\n    }\n\n    let nonJSPrefacingLines = 0;\n    let nonJSPrefacingCols = 0;\n\n    if (exampleCodeRegex) {\n      const idx = source.search(exampleCodeRegex);\n\n      // Strip out anything preceding user regex match (can affect line numbering)\n      let preMatchLines = 0;\n\n      const preMatch = source.slice(0, idx);\n\n      preMatchLines = countChars(preMatch, '\\n');\n\n      nonJSPrefacingLines = preMatchLines;\n\n      const colDelta = preMatchLines ?\n        preMatch.slice(preMatch.lastIndexOf('\\n') + 1).length - initialTagLength :\n        preMatch.length;\n\n      // Get rid of text preceding user regex match (even if it leaves valid JS, it\n      //   could cause us to count newlines twice)\n      source = source.slice(idx);\n\n      source = source.replace(exampleCodeRegex, (n0, n1) => {\n        if (!n1) {\n          return n0;\n        }\n\n        const index = n0.indexOf(n1);\n        const nonJSPreface = n0.slice(0, index);\n        const nonJSPrefaceLineCount = countChars(nonJSPreface, '\\n');\n\n        nonJSPrefacingLines += nonJSPrefaceLineCount;\n\n        // Ignore `preMatch` delta if newlines here\n        if (nonJSPrefaceLineCount) {\n          const charsInLastLine = nonJSPreface.slice(nonJSPreface.lastIndexOf('\\n') + 1).length;\n\n          nonJSPrefacingCols += charsInLastLine - initialTagLength;\n        } else {\n          nonJSPrefacingCols += colDelta + nonJSPreface.length;\n        }\n\n        return n1;\n      });\n    }\n\n    // Programmatic ESLint API: https://eslint.org/docs/developer-guide/nodejs-api\n    const cli = new CLIEngine({\n      allowInlineConfig,\n      baseConfig,\n      configFile,\n      reportUnusedDisableDirectives,\n      rulePaths,\n      rules,\n      useEslintrc: eslintrcForExamples\n    });\n\n    let messages;\n\n    if (filename) {\n      const config = cli.getConfigForFile(filename);\n      const linter = new Linter();\n\n      const linterRules = [...cli.getRules().entries()].reduce((obj, [key, val]) => {\n        obj[key] = val;\n\n        return obj;\n      }, {});\n\n      linter.defineRules(linterRules);\n\n      messages = linter.verify(source, config, {\n        filename,\n        reportUnusedDisableDirectives\n      });\n    } else {\n      ({results: [{messages}]} =\n        cli.executeOnText(source));\n    }\n\n    // NOTE: `tag.line` can be 0 if of form `/** @tag ... */`\n    const codeStartLine = tag.line + nonJSPrefacingLines;\n    const codeStartCol = likelyNestedJSDocIndentSpace;\n\n    messages.forEach(({message, line, column, severity, ruleId}) => {\n      const startLine = codeStartLine + line + zeroBasedLineIndexAdjust;\n      const startCol = codeStartCol + (\n\n        // This might not work for line 0, but line 0 is unlikely for examples\n        line <= 1 ? nonJSPrefacingCols + firstLinePrefixLength : preTagSpaceLength\n      ) + column;\n\n      // Could perhaps make fixable\n      report(\n        '@example ' + (severity === 2 ? 'error' : 'warning') +\n          (ruleId ? ' (' + ruleId + ')' : '') + ': ' +\n          message,\n        null,\n        {\n          column: startCol,\n          line: startLine\n        }\n      );\n    });\n  });\n}, {\n  meta: {\n    type: 'suggestion'\n  },\n  returns: [\n    'ArrowFunctionExpression',\n    'ClassDeclaration',\n    'FunctionDeclaration',\n    'FunctionExpression'\n  ]\n});\n"],"file":"checkExamples.js"}